<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insulin Drip Titration Protocol | Interactive Tool</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome (for icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chosen Palette: Clinical Calm (Warm Neutral Background, Medical Blue Primary, Functional Alert Colors) -->
    <!-- Application Structure Plan: 
         1. Header: Clear identification and Safety Disclaimer.
         2. Split View Layout:
            - Left Column: "Active Calculator". This is the primary tool for user interaction. It takes inputs and provides the specific output based on the protocol logic.
            - Right Column: "Protocol Explorer". This contextualizes the calculator's result. It includes:
                a. Visual Decision Tree (Dynamic cards showing which rule triggered).
                b. Delta Logic Visualization (Chart.js showing how rate magnitude affects step size).
         3. This structure separates the "What do I do now?" (Calculator) from the "Why?" (Educational Logic), facilitating both quick clinical use and deep understanding.
    -->
    <!-- Visualization & Content Choices:
         - Calculator: Interactive form fields with immediate JS validation/calculation. Goal: Inform/Action.
         - Logic Display: Dynamic HTML Cards that highlight the active rule. Goal: Explain/Context.
         - Delta Chart: Chart.js Bar Chart. Shows the "Step Function" nature of the Delta values based on current rate. Goal: Relationship/Reference. Justification: Visualizing the step-up in aggressiveness is clearer than a text table.
         - NO SVG / Mermaid as requested.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; color: #1F2937; }
        
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }

        /* Custom Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            width: 100%; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3B82F6;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #D1D5DB;
            border-radius: 2px;
        }

        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .logic-card { transition: all 0.3s ease; border-left: 4px solid transparent; }
        .logic-card.active { border-left-color: #3B82F6; background-color: #EFF6FF; }
        .logic-card.active .status-icon { color: #3B82F6; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header Section -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-syringe text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 leading-tight">Insulin Titration Protocol</h1>
                    <p class="text-xs text-gray-500">Interactive Clinical Support Tool</p>
                </div>
            </div>
            <button onclick="document.getElementById('about-modal').classList.remove('hidden')" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                Protocol Details
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        
        <!-- Safety Warning -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8 rounded-r-md">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        <strong class="font-medium">Verification Required:</strong> This tool is for educational and calculation support only. Always double-check results against your facility's official written protocol before patient administration.
                    </p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- LEFT COLUMN: Calculator -->
            <section class="lg:col-span-5 flex flex-col space-y-6">
                
                <!-- Introduction to Calculator -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Drip Rate Calculator</h2>
                    <p class="text-sm text-gray-600 mb-6">
                        Enter the patient's previous and current Capillary Blood Glucose (CBG) values along with the current infusion rate. The system will apply the "Change Rate To" logic automatically.
                    </p>

                    <!-- Input Form -->
                    <div class="space-y-5">
                        <!-- Previous CBG -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Previous CBG (mg/dL)</label>
                            <div class="relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fa-solid fa-clock-rotate-left text-gray-400"></i>
                                </div>
                                <input type="number" id="prevCBG" class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 pr-12 sm:text-sm border-gray-300 rounded-md py-3 border" placeholder="e.g., 250" oninput="calculateProtocol()">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">mg/dL</span>
                                </div>
                            </div>
                        </div>

                        <!-- Current CBG -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Current CBG (mg/dL)</label>
                            <div class="relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fa-solid fa-droplet text-gray-400"></i>
                                </div>
                                <input type="number" id="currCBG" class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 pr-12 sm:text-sm border-gray-300 rounded-md py-3 border" placeholder="e.g., 180" oninput="calculateProtocol()">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">mg/dL</span>
                                </div>
                            </div>
                        </div>

                        <!-- Current Rate -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Current Rate (units/hr)</label>
                            <div class="relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fa-solid fa-gauge-high text-gray-400"></i>
                                </div>
                                <input type="number" id="currRate" step="0.1" class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 pr-12 sm:text-sm border-gray-300 rounded-md py-3 border" placeholder="e.g., 5.0" oninput="calculateProtocol()">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">u/hr</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex space-x-3 pt-2">
                            <button onclick="resetForm()" class="flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-200 transition text-sm font-medium">Reset</button>
                            <!-- Calculation happens automatically, but a button provides a visual anchor -->
                            <button class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md shadow hover:bg-blue-700 transition text-sm font-medium cursor-default">
                                <i class="fa-solid fa-calculator mr-2"></i> Auto-Calculating
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Result Card -->
                <div id="resultCard" class="bg-gray-800 text-white rounded-xl card-shadow p-6 hidden transition-all duration-300 transform">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-gray-300 text-sm uppercase tracking-wider font-semibold">Recommended Action</h3>
                        <span id="deltaBadge" class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full font-bold">Calculating...</span>
                    </div>
                    
                    <div class="flex items-baseline space-x-2 mb-2">
                        <span class="text-4xl font-bold text-white" id="newRateDisplay">--</span>
                        <span class="text-lg text-gray-400">units/hr</span>
                    </div>
                    
                    <p id="actionText" class="text-gray-300 text-sm mb-4 border-t border-gray-700 pt-3">
                        Waiting for complete data...
                    </p>

                    <div class="bg-gray-700 rounded p-3 text-xs text-gray-400 flex justify-between">
                        <span>Delta Value Used:</span>
                        <strong id="deltaValueUsed" class="text-white">--</strong>
                    </div>
                </div>
            </section>

            <!-- RIGHT COLUMN: Visualization & Logic -->
            <section class="lg:col-span-7 flex flex-col space-y-6">
                
                <!-- Logic Visualizer Intro -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="border-b border-gray-200 pb-4 mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">Protocol Logic Explorer</h2>
                        <p class="text-sm text-gray-500 mt-1">
                            This section dynamically highlights the active rule based on your inputs. It breaks down the decision process into "Condition" and "Action" for the specific CBG range.
                        </p>
                    </div>

                    <!-- Dynamic Logic Visualization -->
                    <div id="logicContainer" class="space-y-3">
                        <div class="text-center py-10 text-gray-400">
                            <i class="fa-solid fa-arrow-left mr-2"></i> Enter values on the left to see the logic path.
                        </div>
                    </div>
                </div>

                <!-- Delta Chart Container -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800">Delta Value Tiers</h2>
                            <p class="text-sm text-gray-500">How "1 Delta" changes based on current rate.</p>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="deltaChart"></canvas>
                    </div>
                    
                    <div class="mt-4 text-xs text-gray-500 italic text-center">
                        Higher infusion rates trigger larger delta adjustments to combat insulin resistance.
                    </div>
                </div>

            </section>
        </div>
    </main>

    <!-- Modal for Full Text Protocol -->
    <div id="about-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Protocol Reference</h3>
                    <button onclick="document.getElementById('about-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-500">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="mt-4 h-96 overflow-y-auto text-sm text-gray-600 space-y-4">
                    <h4 class="font-bold text-gray-800">Delta Value Table</h4>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Rate &lt; 3: 1Δ = 0.5</li>
                        <li>Rate 3 - 6: 1Δ = 1</li>
                        <li>Rate 6.5 - 9.5: 1Δ = 1.5</li>
                        <li>Rate 10 - 14.5: 1Δ = 2</li>
                        <li>Rate 15 - 19.5: 1Δ = 3</li>
                        <li>Rate 20 - 24.5: 1Δ = 4</li>
                        <li>Rate ≥ 25: 1Δ = 5</li>
                    </ul>
                    <hr>
                    <h4 class="font-bold text-gray-800">Rules Summary</h4>
                    <p><strong>CBG ≥ 200:</strong> Aggressive increase if rising. Maintenance only if dropping 26-75.</p>
                    <p><strong>CBG 140-199:</strong> Moderate increase if rising. Maintenance if dropping 1-50.</p>
                    <p><strong>CBG 100-139:</strong> Increase only if >25 rise. Wide maintenance window.</p>
                    <p><strong>CBG 75-99:</strong> Defensive posture. Maintain if rising, decrease if dropping.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        const state = {
            prevCBG: null,
            currCBG: null,
            currRate: null,
            deltaValue: 0,
            deltaMultiplier: 0,
            activeRange: null // '200+', '140-199', '100-139', '75-99', 'Low'
        };

        // --- Delta Logic (Reference Data) ---
        const deltaRules = [
            { min: 0, max: 2.99, one: 0.5, two: 1.0 },
            { min: 3, max: 6.0, one: 1.0, two: 2.0 },
            { min: 6.5, max: 9.5, one: 1.5, two: 3.0 },
            { min: 10, max: 14.5, one: 2.0, two: 4.0 },
            { min: 15, max: 19.5, one: 3.0, two: 6.0 },
            { min: 20, max: 24.5, one: 4.0, two: 8.0 },
            { min: 25, max: 999, one: 5.0, two: 10.0 }
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
        });

        function resetForm() {
            document.getElementById('prevCBG').value = '';
            document.getElementById('currCBG').value = '';
            document.getElementById('currRate').value = '';
            document.getElementById('resultCard').classList.add('hidden');
            document.getElementById('logicContainer').innerHTML = `
                <div class="text-center py-10 text-gray-400">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Enter values on the left to see the logic path.
                </div>`;
            state.activeRange = null;
            updateChartHighlight();
        }

        // --- Core Calculation Logic ---
        function calculateProtocol() {
            const pCBG = parseFloat(document.getElementById('prevCBG').value);
            const cCBG = parseFloat(document.getElementById('currCBG').value);
            const rate = parseFloat(document.getElementById('currRate').value);

            if (isNaN(pCBG) || isNaN(cCBG) || isNaN(rate)) {
                // Incomplete data
                return;
            }

            state.prevCBG = pCBG;
            state.currCBG = cCBG;
            state.currRate = rate;

            // 1. Determine Delta Value based on Rate
            let oneDelta = 0;
            let twoDelta = 0;
            
            // Logic to find delta tier
            if(rate < 3) { oneDelta=0.5; twoDelta=1; }
            else if(rate <= 6) { oneDelta=1; twoDelta=2; }
            else if(rate <= 9.5) { oneDelta=1.5; twoDelta=3; }
            else if(rate <= 14.5) { oneDelta=2; twoDelta=4; }
            else if(rate <= 19.5) { oneDelta=3; twoDelta=6; }
            else if(rate <= 24.5) { oneDelta=4; twoDelta=8; }
            else { oneDelta=5; twoDelta=10; }

            state.deltaValue = oneDelta;

            // 2. Determine Multiplier based on CBG Change
            const diff = cCBG - pCBG; // Positive = Increase, Negative = Decrease
            let multiplier = 0;
            let logicText = "";
            let rangeName = "";

            if (cCBG >= 200) {
                rangeName = "200+";
                if (diff > 0) { multiplier = 2; logicText = "Increase in CBG"; }
                else if (diff === 0 || (diff >= -25 && diff < 0)) { multiplier = 1; logicText = "Unchanged or Decrease 1-25"; }
                else if (diff >= -75 && diff < -25) { multiplier = 0; logicText = "Decrease 26-75"; }
                else if (diff >= -100 && diff < -75) { multiplier = -1; logicText = "Decrease 76-100"; }
                else { multiplier = -2; logicText = "Decrease > 100"; }
            } 
            else if (cCBG >= 140) {
                rangeName = "140-199";
                if (diff > 50) { multiplier = 2; logicText = "Increase > 50"; }
                else if (diff >= 0 && diff <= 50) { multiplier = 1; logicText = "Unchanged or Increase 1-50"; }
                else if (diff >= -50 && diff < 0) { multiplier = 0; logicText = "Decrease 1-50"; }
                else if (diff >= -75 && diff < -50) { multiplier = -1; logicText = "Decrease 51-75"; }
                else { multiplier = -2; logicText = "Decrease > 75"; }
            }
            else if (cCBG >= 100) {
                rangeName = "100-139";
                if (diff > 25) { multiplier = 1; logicText = "Increase > 25"; }
                else if (diff >= -25 && diff <= 25) { multiplier = 0; logicText = "Unchanged, Incr 1-25, or Decr 1-25"; }
                else if (diff >= -50 && diff < -25) { multiplier = -1; logicText = "Decrease 26-50"; }
                else { multiplier = -2; logicText = "Decrease > 50"; }
            }
            else if (cCBG >= 75) {
                rangeName = "75-99";
                if (diff > 0) { multiplier = 0; logicText = "Increase of any value"; }
                else if (diff >= -25 && diff <= 0) { multiplier = -1; logicText = "Unchanged or Decrease 1-25"; }
                else { multiplier = -2; logicText = "Decrease > 25"; }
            }
            else {
                rangeName = "Hypoglycemia (<75)";
                multiplier = 0; // Usually specific hypoglycemia protocol, defaulting to 0/Hold here for safety in this specific algo context, but UI should warn.
                logicText = "CBG < 75. Follow Hypoglycemia Protocol.";
            }

            state.deltaMultiplier = multiplier;
            state.activeRange = rangeName;

            // 3. Calculate Final Rate
            let changeAmount = 0;
            if (Math.abs(multiplier) === 1) changeAmount = oneDelta;
            if (Math.abs(multiplier) === 2) changeAmount = twoDelta;
            
            // Apply sign
            if (multiplier < 0) changeAmount = -changeAmount;
            
            let newRate = rate + changeAmount;
            if (newRate < 0) newRate = 0;

            // 4. Update UI
            updateUI(newRate, multiplier, logicText, oneDelta, rangeName, diff);
            updateChartHighlight(rate);
        }

        function updateUI(newRate, multiplier, logicText, oneDelta, rangeName, diff) {
            // Show Result Card
            const card = document.getElementById('resultCard');
            card.classList.remove('hidden');

            // Format New Rate
            document.getElementById('newRateDisplay').textContent = newRate.toFixed(1);

            // Badge text
            const badge = document.getElementById('deltaBadge');
            if (multiplier > 0) {
                badge.className = "bg-red-500 text-white text-xs px-2 py-1 rounded-full font-bold";
                badge.textContent = `+${Math.abs(multiplier)} Delta`;
            } else if (multiplier < 0) {
                badge.className = "bg-green-500 text-white text-xs px-2 py-1 rounded-full font-bold";
                badge.textContent = `${multiplier} Delta`;
            } else {
                badge.className = "bg-gray-500 text-white text-xs px-2 py-1 rounded-full font-bold";
                badge.textContent = "Maintain Rate";
            }

            // Explainer Text
            document.getElementById('actionText').innerHTML = 
                `<strong>Context:</strong> Patient is in the <span class="text-blue-300">${rangeName}</span> range. 
                 CBG change is <span class="font-mono">${diff > 0 ? '+' : ''}${diff}</span> (${logicText}).`;

            document.getElementById('deltaValueUsed').textContent = oneDelta + " units";

            // Render Logic Tree
            renderLogicTree(rangeName, diff);
        }

        function renderLogicTree(activeRange, currentDiff) {
            const container = document.getElementById('logicContainer');
            
            // Define rules for rendering (Simplified for visual clarity)
            const ranges = {
                '200+': [
                    { cond: 'Increase', action: '+2 Delta', active: currentDiff > 0 },
                    { cond: 'Unchanged / Decrease 1-25', action: '+1 Delta', active: currentDiff <= 0 && currentDiff >= -25 },
                    { cond: 'Decrease 26-75', action: 'Maintain', active: currentDiff < -25 && currentDiff >= -75 },
                    { cond: 'Decrease 76-100', action: '-1 Delta', active: currentDiff < -75 && currentDiff >= -100 },
                    { cond: 'Decrease > 100', action: '-2 Delta', active: currentDiff < -100 }
                ],
                '140-199': [
                    { cond: 'Increase > 50', action: '+2 Delta', active: currentDiff > 50 },
                    { cond: 'Unchanged / Increase 1-50', action: '+1 Delta', active: currentDiff >= 0 && currentDiff <= 50 },
                    { cond: 'Decrease 1-50', action: 'Maintain', active: currentDiff < 0 && currentDiff >= -50 },
                    { cond: 'Decrease 51-75', action: '-1 Delta', active: currentDiff < -50 && currentDiff >= -75 },
                    { cond: 'Decrease > 75', action: '-2 Delta', active: currentDiff < -75 }
                ],
                '100-139': [
                    { cond: 'Increase > 25', action: '+1 Delta', active: currentDiff > 25 },
                    { cond: 'Unchanged / ±25 Change', action: 'Maintain', active: currentDiff <= 25 && currentDiff >= -25 },
                    { cond: 'Decrease 26-50', action: '-1 Delta', active: currentDiff < -25 && currentDiff >= -50 },
                    { cond: 'Decrease > 50', action: '-2 Delta', active: currentDiff < -50 }
                ],
                '75-99': [
                    { cond: 'Increase (Any)', action: 'Maintain', active: currentDiff > 0 },
                    { cond: 'Unchanged / Decrease 1-25', action: '-1 Delta', active: currentDiff <= 0 && currentDiff >= -25 },
                    { cond: 'Decrease > 25', action: '-2 Delta', active: currentDiff < -25 }
                ]
            };

            const rules = ranges[activeRange];
            if (!rules) {
                container.innerHTML = `<div class="bg-red-100 p-4 rounded text-red-800 font-bold">Hypoglycemia Protocol Required</div>`;
                return;
            }

            let html = `<h3 class="text-sm font-bold text-gray-500 mb-2 uppercase">Range: ${activeRange} mg/dL</h3>`;
            
            rules.forEach(rule => {
                html += `
                <div class="logic-card ${rule.active ? 'active' : 'bg-white'} p-3 rounded border border-gray-100 mb-2 flex justify-between items-center">
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full ${rule.active ? 'bg-blue-500' : 'bg-gray-300'} mr-3"></div>
                        <span class="text-sm ${rule.active ? 'font-bold text-gray-800' : 'text-gray-500'}">${rule.cond}</span>
                    </div>
                    <span class="text-xs font-mono px-2 py-1 rounded ${rule.active ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-400'}">${rule.action}</span>
                </div>`;
            });

            container.innerHTML = html;
        }

        // --- Chart.js Implementation ---
        let deltaChartInstance = null;

        function initChart() {
            const ctx = document.getElementById('deltaChart').getContext('2d');
            
            // Data prep
            const labels = ["0-3", "3-6", "6.5-9.5", "10-14.5", "15-19.5", "20-24.5", "25+"];
            const dataValues = [0.5, 1, 1.5, 2, 3, 4, 5];

            deltaChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Size of 1 Delta (Units)',
                        data: dataValues,
                        backgroundColor: dataValues.map(() => '#E5E7EB'), // Default gray
                        borderColor: '#D1D5DB',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Delta Size (Units)' }
                        },
                        x: {
                            title: { display: true, text: 'Current Rate Range (u/hr)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `1 Delta = ${context.raw} units`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChartHighlight(currentRate) {
            if (!deltaChartInstance) return;
            
            const colors = deltaChartInstance.data.datasets[0].backgroundColor;
            // Reset colors
            for (let i = 0; i < colors.length; i++) colors[i] = '#E5E7EB';

            if (currentRate !== undefined && currentRate !== null) {
                let index = -1;
                if(currentRate < 3) index = 0;
                else if(currentRate <= 6) index = 1;
                else if(currentRate <= 9.5) index = 2;
                else if(currentRate <= 14.5) index = 3;
                else if(currentRate <= 19.5) index = 4;
                else if(currentRate <= 24.5) index = 5;
                else index = 6;

                if (index >= 0) {
                    colors[index] = '#3B82F6'; // Highlight Blue
                }
            }
            
            deltaChartInstance.update();
        }

    </script>
</body>
</html>